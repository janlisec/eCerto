---
#title: "eCerto Analyte Report"
params:
  General: NA
  Certification: NA
  selected_tab: NA
output:
  word_document: 
    reference_docx: template.docx
  pdf_document:
    latex_engine: lualatex
  html_document:
    df_print: paged
fontsize: 11pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
# get a local representation of all data provided by Shiny
# setting testing <- TRUE will load test data for development of the Rmd
testing <- TRUE
if (testing) {
  tmp <- new.env()
  load(file = "C:/Users/jlisec/Documents/Projects/BAMTool_Backup/Testdaten/JL2/CRM001.RData", envir = tmp)
  res <- get(x = "res", envir = tmp)
  G <- res$General
  C <- res$Certification
  A <- ifelse(!is.null(res$selected_tab), res$selected_tab, names(G$apm)[1])
  D <- G$apm[[A]]
} else {
  G <- params$General
  C <- params$Certification
  A <- ifelse(params$selected_tab %in% names(G$apm), params$selected_tab, names(G$apm)[1])
  D <- G$apm[[A]]
}
```

## *eCerto* Analyte Report

**Study ID: `r G$study_id`**  
**User: `r G$user`**  
**Date: `r format(Sys.time(), '%d %B, %Y')`**

**Analyte: `r A`**  

### Data Import

These files have been provided to the tool by `r G$user`:

```{r data_files, echo=FALSE, comment=NA}
cat(paste(C$input_files, collapse=",\n"))
```

This is the imported data which was basis for all further calculations:

```{r data_table, echo=FALSE}
df <- knitr::kable(C$data[C$data[,"analyte"]==A,1:7,drop=FALSE], row.names=FALSE, format.args = list(decimal.mark = "."))
if (knitr::is_html_output()) {
  kableExtra::kable_styling(df, font_size = 9)
} else {
  df
  #knitr::kable(C$data[C$data[,"analyte"]==A,1:7,drop=FALSE], row.names=FALSE, format.args = list(decimal.mark = "."))
}
```

### Statistics regarding lab means, lab variances and outlier detection

```{r echo=FALSE, comment=NA}
knitr::kable(data.frame("Tab1"=NA), row.names=FALSE, format.args = list(decimal.mark = "."))
#     Stats <- eval(parse(text=C$stats$fnc))
# if (C$opt$show_code) {
#     cat("Function call:\n")  
#     tmp <- deparse(Stats, width.cutoff = 56L) 
#     for (i in 1:length(tmp)){
#       cat(tmp[i])
#       cat("\n")
#       }
#     } 
#     cat(paste("Selected precision:", precision, "\n")) knitr::kable(eval(C$stats$call), row.names=FALSE, format.args = list(decimal.mark = ","))
#  
```

`r ifelse(!is.null(D$sample_filter), "The following samples (IDs) have been removed by the user upon inspection of the oulier statistics:", "")`

```{r, echo=FALSE, comment=NA} 
cat(paste(D$sample_filter, collapse=", ")) 
```

### Statistics regarding overall mean distribution and variance testing

```{r eval=TRUE, echo=FALSE, comment=NA}
knitr::kable(data.frame("Tab2"=NA), row.names=FALSE, format.args = list(decimal.mark = "."))
#     mstats <- eval(parse(text=C$mstats$fnc))
# if (C$opt$show_code) { 
#     cat("Function call:\n")  
#   tmp <- deparse(mstats, width.cutoff = 56L) 
#     for (i in 1:length(tmp))  {
#       cat(tmp[i])
#       cat("\n")}
#   }
#   cat(paste(C$normality_statement, "\n")) knitr::kable(eval(C$mstats$call), row.names=FALSE, format.args = list(decimal.mark = ",")) 
```

`r ifelse(!is.null(D$lab_filter), "The following Labs (IDs) have been removed by the user upon inspection of the oulier statistics:", "")`

```{r, eval=!is.null(D$lab_filter), echo=FALSE, comment=NA} 
cat(paste(D$lab_filter, collapse=", ")) 
```

### Certified Values Plot

```{r, eval=TRUE, echo=FALSE, comment=NA, fig.width=480/72, fig.height=480/72}
plot(1:10)
# CertValPlot <- eval(parse(text=C$CertValPlot$fnc))
# if (C$opt$show_code) {
#   cat("Function call:\n")
#   tmp <- deparse(CertValPlot)
#   for (i in 1:length(tmp)) {
#     cat(tmp[i])
#     cat("\n")}
#   }
# eval(C$CertValPlot$call)
```

### Certified Value and uncertainty contributions

Here we could include the Tab.3 from the App including the certified values. However, this might be better done in the Material Report/Certificate.

***Note!*** This is a Report template for demonstration purpose. Specific layouts can be generated on demand.