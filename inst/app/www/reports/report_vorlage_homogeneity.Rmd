---
title: '&nbsp;'
title-meta: "Homogeneity-Report"
params:
  Homogeneity: NA
output:
  html_document:
    df_print: paged
---

***Note!*** 
This is a general report template. Specific layouts can be generated on demand.

---

## ***eCerto*** Report

**Date: `r format(Sys.time(), '%d %B, %Y')`**

### Modul: Homogeneity

```{r data, echo=FALSE}
# get a local representation of all data provided by Shiny
testing <- length(params$Homogeneity)==1L && (is.na(params$Homogeneity) | params$Homogeneity=="NA")
if (testing) {
  res <- eCerto::CRM001
  H <- res[["Homogeneity"]]
  #'x <- eCerto:::test_homog()$data
} else {
  H <- params$Homogeneity
}
if (!"H_type" %in% colnames(H[["data"]])) H[["data"]] <- cbind(H[["data"]], "H_type"="hom")
sa <- interaction(H[["data"]][,"analyte"],H[["data"]][,"H_type"])
# get figure width in pixel
figs_w <- sapply(levels(sa), function(a) {
  n <- length(levels(factor(H[["data"]][sa==a,"Flasche"])))
  return(150 + 40 * n)
})
# convert width to inch on screen
figs_w <- figs_w/72
# normalize to max width
max_width <- max(960/72, figs_w)
figs_w <- figs_w/max_width
  
```

This is the table of uncertainties associated with homogeneity:

```{r, echo=FALSE, comment=NA, message=FALSE, warning=FALSE}
df <- eCerto:::prepTabH1(x = H[["data"]])
if (knitr::is_html_output()) {
  eCerto:::styleTabH1(x = df, output = "dt")
} else if (knitr::is_latex_output()) {
  knitr::kable(df, row.names=FALSE, format="latex", format.args = list(decimal.mark = "."))
}
```

`r paste(ifelse(any(df[,"P"]<=0.05), "Not all", "All"), "analytes are homogenous between bottles.")`

`r ifelse(length(unique(H[["data"]][,"analyte"])>=2), "These are the individual Homogeneity boxplots:", "This is the Homogeneity boxplot:")`

```{r, echo=FALSE, comment=NA, message=FALSE, fig.width=max_width, fig.height=5*length(figs_w)}
widths <- diff(c(0,sort(unique(figs_w)),1))
mat <- matrix(0, nrow = length(figs_w), ncol = length(widths))
for (i in 1:nrow(mat)) {
  mat[i,figs_w[i]>=cumsum(widths)] <- i
}
layout(mat = mat, widths = widths)
for (a in levels(sa)) {
  try(eCerto:::prepFigH1(x = H[["data"]], sa = a, prec = 4))
}
```

This is the table of input data:

```{r, echo=FALSE, comment=NA}
df <- H[["data"]]
if (knitr::is_html_output()) {
  kableExtra::kable_styling(knitr::kable(df, format="html", row.names=FALSE, format.args = list(decimal.mark = ".")), font_size = 9)
} else if (knitr::is_latex_output()) {
  knitr::kable(df, row.names=FALSE, format="latex", format.args = list(decimal.mark = "."))
}
```

End of Report.