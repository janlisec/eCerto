name: Gate Auto Merge and Docker Build

on:
  workflow_run:
    workflows: ["R-CMD-check", "test-coverage"]
    types:
      - completed

jobs:
  gate-check:
    runs-on: ubuntu-latest
    steps:
      - name: Check both workflows status
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.payload.workflow_run.head_sha;

            // Hole alle Workflow-Runs fÃ¼r dieses Commit
            const runs = await github.rest.actions.listWorkflowRunsForRepo({
              owner,
              repo,
              per_page: 50
            });

            const ciWorkflows = ["R-CMD-check", "test-coverage"];
            const statuses = ciWorkflows.map(name => {
              const run = runs.data.workflow_runs.find(r => r.name === name && r.head_sha === sha);
              return run ? run.conclusion : null;
            });

            if (statuses.includes(null) || statuses.includes("failure")) {
              core.setFailed(`Nicht alle Workflows erfolgreich: ${statuses}`);
            } else {
              console.log("Alle CI-Workflows erfolgreich.");
            }

merge-and-build:
  needs: gate-check
  runs-on: ubuntu-latest
  if: ${{ success() }}
  steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: Fetch all branches
      run: git fetch --all

    - name: Merge devel into main
      run: |
        git checkout main
        git merge origin/devel --no-ff -m "Auto-merge devel into main after successful CI"
        git push origin main

docker-build:
  needs: merge-and-build
  uses: ./.github/workflows/docker-build.yaml
  with:
    image_tag: latest
